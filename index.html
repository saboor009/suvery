<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clinic Visit Forms with Patient Info Modal</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/survey-core@1.9.92/survey.core.min.js"></script>
  <script src="https://unpkg.com/survey-jquery@1.9.92/survey.jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>

  <link href="https://unpkg.com/survey-core@1.9.92/defaultV2.min.css" rel="stylesheet" />
  <style>
    .transcript-box {
  width: 100%;
  max-width: 800px;         /* Match the form’s max width */
  margin: 20px auto 0 auto; /* Center horizontally */
  padding: 20px;
  background: #ffffff;
  border: 1px solid #e0e0e0;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
  font-family: 'Segoe UI', sans-serif;
  font-size: 14px;
  color: #333;
  max-height: 250px;
  overflow-y: auto;
  white-space: pre-wrap;
  line-height: 1.5;
}

.transcript-title {
  display: block;
  margin-bottom: 12px;
  font-size: 16px;
  font-weight: 600;
  color: #222;
}


    /* Your existing CSS styles (unchanged) */
    #togglePatientInfo {
      font-size: 24px;
      font-weight: bold;
      line-height: 1;
      padding: 6px 12px;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #007bff;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    #togglePatientInfo:hover {
      background-color: rgba(0, 123, 255, 0.1);
    }
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #surveyContainer {
      max-width: 700px;
      margin: auto;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      padding: 20px;
      border-bottom: 1px solid #ddd;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border-radius: 8px;
    }
    #formSelector {
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background-color: #fff;
      color: #333;
    }
    #togglePatientInfo {
      font-weight: bold;
      font-size: 16px;
      padding: 6px 12px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s ease;
    }
    #togglePatientInfo:hover {
      background-color: #0056b3;
    }
    .upload-label {
      background-color: #1db495;
      color: #fff;
      padding: 10px 18px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: background-color 0.3s ease;
    }
    .upload-label:hover {
      background-color: #10876f;
    }
    .status-text {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    /* Modal styles */
    #patientInfoModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #patientInfoModal > div {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      width: 320px;
      max-width: 90%;
      box-sizing: border-box;
    }
    #patientInfoModal h3 {
      margin-top: 0;
    }
    #patientInfoModal label {
      display: block;
      margin-bottom: 10px;
    }
    #patientInfoModal input[type="text"],
    #patientInfoModal input[type="date"] {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 14px;
    }
    #patientInfoModal button {
      margin-top: 10px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      border: none;
    }
    #patientInfoSaveBtn {
      background-color: #28a745;
      color: white;
      margin-right: 10px;
    }
    #patientInfoSaveBtn:hover {
      background-color: #218838;
    }
    #patientInfoCancelBtn {
      background-color: #dc3545;
      color: white;
    }
    #patientInfoCancelBtn:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
<div class="top-bar">
    <label class="upload-label">
      Upload Audio
      <input type="file" id="audioUpload" accept="audio/*" hidden />
    </label>

    
  <label id="jobSelectLabel" for="jobSelector">Select Job ID:</label>
  <select id="jobSelector">
    <option value="">-- Select a Job ID --</option>
  </select>

  <div id="transcriptContainer">Loading transcripts...</div>



   <select id="formSelector" class="form-selector" aria-label="Select Form Type">
  <option value="NewPatient">New Patient</option>
  <option value="ReturningPatient">Returning Patient</option>
  <option value="FocusedEmergencyDeptVisit">Focused Emergency Dept Visit</option>
  <option value="NewAddictionMedVisit">New Addiction Med Visit</option>
  <option value="ReturnPsychVisit">Return Psych Visit</option>
  <option value="PsychotherapySubjective">Psychotherapy Session</option>
  <option value="FollowUpVisit">Follow-Up Visit</option>
  <option value="ReturnBehavioralHealthVisit">Return Behavioral Health Visit</option>
  <option value="NewMedicalVisit">New Medical Visit</option>
  <option value="ReturnAddictionMedVisit">Return Addiction Med Visit</option>
  <option value="NewBehavioralHealthVisit">New Behavioral Health Visit</option>
  <option value="NewPsychVisit">New Psych Visit</option>
  <option value="ReturnMedicalVisit">Return Medical Visit</option>

</select>


    <button id="togglePatientInfo" title="Patient Info" aria-label="Patient Info">+</button>

 <input type="file" id="pdfUpload" accept="application/pdf" style="display:none;" />
<button id="sendPdfBtn" style="
      padding: 12px 28px;
      font-weight: 600;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      background-color: #d93025;
      color: white;
      box-shadow: 0 4px 8px rgba(217, 48, 37, 0.3);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
    ">
  Send PDF to EMR
</button>


    

    <div id="statusMessage"></div>

    <button id="downloadPdfBtn" disabled style="
  padding: 12px 28px;
  font-weight: 600;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  border: none;
  background-color: #007bff;
  color: white;
  box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
  transition: background-color 0.3s ease, box-shadow 0.3s ease;
">
  Download PDF
</button>

  </div>

  <span id="loadingStatus" class="status-text" aria-live="polite"></span>

<div class="transcript-box">
  <strong style="display:block; margin-bottom: 8px; font-size: 16px;">Transcript Preview</strong>
  <div id="transcriptContainerr"></div> <!-- ✅ This is the one that should stay -->
</div>


  <div id="surveyContainer"></div>

 


 <!-- Formatted JSON output -->
<div style="max-width: 700px; margin: 40px auto; padding: 20px; background: #f1f1f1; border-radius: 8px;">
  <h4 style="margin-top: 0;">Formatted Output</h4>
  <div id="formattedJsonOutput" style="background: #fff; padding: 12px; border-radius: 6px; overflow-x: auto;"></div>
</div>




  <!-- Patient Info Modal -->
  <div id="patientInfoModal" role="dialog" aria-modal="true" aria-labelledby="patientInfoModalTitle">
    <div>
      <h3 id="patientInfoModalTitle">Patient Info</h3>
      <form id="patientInfoForm" onsubmit="return false;">
        <label for="modal_first_name">
          First Name<br />
          <input type="text" id="modal_first_name" name="patient_first_name" />
        </label>
        <label for="modal_last_name">
          Last Name<br />
          <input type="text" id="modal_last_name" name="patient_last_name" />
        </label>
        <label for="modal_dob">
          Date of Birth<br />
          <input type="date" id="modal_dob" name="patient_dob" />
        </label>
        <label for="modal_id_number">
          Identification Number<br />
          <input type="text" id="modal_id_number" name="patient_id_number" />
        </label>
        <button type="button" id="patientInfoSaveBtn">Save</button>
        <button type="button" id="patientInfoCancelBtn">Cancel</button>
      </form>
    </div>
  </div>


  

  <script>



   const API_KEY = "OTEaQ3hy00lqC7SGm00brFlB9hJ84HhL"; // Replace with your Speechmatics API key

    let transcriptsMap = {}; // Store jobId -> transcript text for quick access

    async function fetchJobs() {
      const response = await fetch("https://asr.api.speechmatics.com/v2/jobs/", {
        headers: { Authorization: `Bearer ${API_KEY}` }
      });
      if (!response.ok) throw new Error("Failed to fetch jobs");
      return response.json();
    }

    async function fetchTranscript(jobId) {
      const response = await fetch(`https://asr.api.speechmatics.com/v2/jobs/${jobId}/transcript?format=txt`, {
        headers: { Authorization: `Bearer ${API_KEY}` }
      });
      if (!response.ok) throw new Error(`Failed to fetch transcript for job ${jobId}`);
      return response.text();
    }async function loadTranscripts() {
  const container = document.getElementById("transcriptContainer");
  const jobSelector = document.getElementById("jobSelector");

  try {
    const jobsData = await fetchJobs();
    const jobs = jobsData.jobs || [];

    if (jobs.length === 0) {
      container.textContent = "No saved transcripts found.";
      return;
    }

    // Clear container so no transcripts show by default
    container.textContent = "";

    // Populate dropdown with job IDs and datetime (formatted)
    jobs.forEach(job => {
      const jobId = job.id;
      const timestamp = new Date(job.created_at); // assuming 'created_at' holds the datetime
      const formattedDatetime = timestamp.toLocaleString(); // Adjust the format if needed

      const option = document.createElement("option");
      option.value = jobId;
      option.textContent = `Job ID: ${jobId} - Created on: ${formattedDatetime}`; // Show both ID and datetime
      jobSelector.appendChild(option);
    });

    // On selecting a job ID, fetch transcript, fill form and send data to webhook
  document.getElementById("jobSelector").addEventListener("change", async function () {
  const selectedJobId = this.value;
  const container = document.getElementById("transcriptContainerr");

  if (!selectedJobId) return;

  container.textContent = "Loading transcript...";

  try {

    
  const transcriptText = await fetchTranscript(selectedJobId);  // <-- gets the transcript
    container.innerHTML = transcriptText.replace(/\n/g, "<br>"); // <-- shows it immediately


    // Send transcript to webhook
    const response = await fetch("https://acai.app.n8n.cloud/webhook/speechmatics", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ transcriptText }),
    });

    if (!response.ok) throw new Error("Failed to send data to webhook");

    const data = await response.json();
    const objData = Array.isArray(data) && data.length > 0 ? data[0] : data;

    // Fill the form
    fillSurveyFromData(objData);

    // Update formatted output
    const formattedOutputEl = document.getElementById("formattedJsonOutput");
    if (formattedOutputEl && objData.formatted_json_output) {
      formattedOutputEl.innerHTML = objData.formatted_json_output;
    }

    alert("Raw transcirpt being processed...");
  } catch (error) {
    container.textContent = "Error loading transcript.";
    console.error("Error:", error);
  }
});


  } catch (err) {
    container.textContent = "Error loading job list.";
    console.error(err);
  }
}

   function fillFormWithTranscript(text) {
const transcriptText = "This is your transcript.\nIt has multiple lines.\nMake sure it's readable.";

// Get the container and update it with line breaks
const transcriptBox = document.getElementById("transcriptContainer");
transcriptBox.innerHTML = transcriptText.replace(/\n/g, "<br>");


  document.body.appendChild(transcriptField); // Append to the DOM

  // Check if the element exists before setting the value
  if (textarea) {
    textarea.value = text;
    textarea.focus();
    alert("Form filled with transcript text.");
  } else {
    console.error("Element with id 'transcriptField' not found.");
  }
}



async function fillFormFromWebhookTest() {
  const status = document.getElementById("loadingStatus");
  status.textContent = "Fetching data from webhook-test...";

  try {
    const response = await fetch("https://acai.app.n8n.cloud/webhook/speechmatics");
    if (!response.ok) throw new Error("Failed to fetch from webhook-test");

    const data = await response.json();
    const objData = Array.isArray(data) && data.length > 0 ? data[0] : data;

    console.log("Data from webhook-test:", objData);
    fillSurveyFromData(objData); // Filling the form with the fetched data

    const formattedOutputEl = document.getElementById("formattedJsonOutput");
    if (formattedOutputEl && data.formatted_json_output) {
      formattedOutputEl.innerHTML = data.formatted_json_output;
    }

    status.textContent = "Form filled from webhook-test data.";
    setTimeout(() => (status.textContent = ""), 3000);

  } catch (error) {
    console.error("Error fetching webhook-test data:", error);
    status.textContent = "";
  }
}

    loadTranscripts();


    

    const formTemplates = {
     NewPatient: {
  title: "New Patient",
  elements: [
    {
      type: "panel",
      name: "subjective_panel",
      title: "Subjective",
      elements: [
        { type: "comment", name: "np_chief_complaint", title: "Chief Complaint" },
        { type: "comment", name: "np_present_illness", title: "History of Present Illness" },
        { type: "comment", name: "np_medical_history", title: "Medical History" },
        { type: "comment", name: "np_surgical_history", title: "Surgical History" },
        { type: "comment", name: "np_medications_supplements", title: "Medications and Supplements" },
        { type: "comment", name: "np_allergies", title: "Allergies" },
        { type: "comment", name: "np_social_history", title: "Social History" },
        { type: "comment", name: "np_family_history", title: "Family History" },
        { type: "comment", name: "np_review_of_systems", title: "Review of Systems" }
      ]
    },
    {
      type: "panel",
      name: "objective_panel",
      title: "Objective",
      elements: [
        { type: "comment", name: "np_mental_status_exam", title: "Mental Status Examination" },
        { type: "comment", name: "np_vital_signs", title: "Vital Signs" },
        { type: "comment", name: "np_lab_imaging_test_results", title: "Laboratory, Imaging, and Diagnostic Test Results" },
        { type: "comment", name: "np_rating_scales", title: "Rating Scales" }
      ]
    },
    {
      type: "panel",
      name: "assessment_panel",
      title: "Assessment and Plan",
      elements: [
        { type: "comment", name: "np_assessment_plan", title: "Assessment and Plan" }
      ]
    }
  ]
},
ReturningPatient: {
    title: "Returning Patient",
    elements: [
      {
        type: "panel",
        name: "subjective_panel",
        title: "Subjective",
        elements: [
          { type: "comment", name: "rp_chief_complaint", title: "Chief Complaint" },
          { type: "comment", name: "rp_present_illness", title: "History of Present Illness" },
          { type: "comment", name: "rp_medications_supplements", title: "Medications and Supplements" }
        ]
      },
      {
        type: "panel",
        name: "objective_panel",
        title: "Objective",
        elements: [
          { type: "comment", name: "rp_mental_status_exam", title: "Mental Status Examination" },
          { type: "comment", name: "rp_vital_signs", title: "Vital Signs" },
          { type: "comment", name: "rp_lab_imaging_test_results", title: "Laboratory, Imaging, and Diagnostic Test Results" },
          { type: "comment", name: "rp_rating_scales", title: "Rating Scales" }
        ]
      }
    ]
  },
       FocusedEmergencyDeptVisit:{
  "title": "Focused Emergency Dept Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "fud_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "fud_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "fud_medications_supplements", "title": "Medications and Supplements" },
        { "type": "comment", "name": "fud_allergies", "title": "Allergies" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "fud_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "fud_physical_exam", "title": "Physical Examination" },
        { "type": "comment", "name": "fud_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment and Plan",
      "elements": [
        { "type": "comment", "name": "fud_medical_decision_making", "title": "Medical Decision Making" },
        { "type": "comment", "name": "fud_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
     NewAddictionMedVisit: {
  "title": "New Addiction Med Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "nam_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "nam_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "nam_medical_history", "title": "Medical History" },
        { "type": "comment", "name": "nam_surgical_history", "title": "Surgical History" },
        { "type": "comment", "name": "nam_medications_supplements", "title": "Medications and Supplements" },
        { "type": "comment", "name": "nam_allergies", "title": "Allergies" },
        { "type": "comment", "name": "nam_social_history", "title": "Social History" },
        { "type": "comment", "name": "nam_family_history", "title": "Family History" },
        { "type": "comment", "name": "nam_review_of_systems", "title": "Review of Systems" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "nam_mental_status_exam", "title": "Mental Status Examination" },
        { "type": "comment", "name": "nam_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "nam_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" },
        { "type": "comment", "name": "nam_rating_scales", "title": "Rating Scales" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment and Plan",
      "elements": [
        { "type": "comment", "name": "nam_assessment_plan", "title": "Assessment and Plan" }
      ]
    }
  ]
},
   ReturnPsychVisit: {
  "title": "Return Psych Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "rpv_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "rpv_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "rpv_medications_supplements", "title": "Medications and Supplements" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "rpv_mental_status_exam", "title": "Mental Status Examination" },
        { "type": "comment", "name": "rpv_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "rpv_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" },
        { "type": "comment", "name": "rpv_rating_scales", "title": "Rating Scales" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment and Plan",
      "elements": [
        { "type": "comment", "name": "rpv_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
   PsychotherapySubjective: {
  "title": "Psychotherapy Subjective",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "pss_subjective", "title": "Psychotherapy Subjective" },
        { "type": "comment", "name": "pss_medications_supplements", "title": "Medications and Supplements" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "pss_mental_status_exam", "title": "Mental Status Examination" },
        { "type": "comment", "name": "pss_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "pss_rating_scales", "title": "Rating Scales" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment and Plan",
      "elements": [
        { "type": "comment", "name": "pss_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
   FollowUpVisit:{
  "title": "Follow-Up Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "fuv_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "fuv_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "fuv_medications_supplements", "title": "Medications and Supplements" },
        { "type": "comment", "name": "fuv_review_of_systems", "title": "Review of Systems" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "fuv_physical_exam", "title": "Physical Examination" },
        { "type": "comment", "name": "fuv_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "fuv_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment and Plan",
      "elements": [
        { "type": "comment", "name": "fuv_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
  ReturnBehavioralHealthVisit:{
  "title": "Return Behavioral Health Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "rbh_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "rbh_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "rbh_medications_supplements", "title": "Medications and Supplements" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "rbh_mental_status_exam", "title": "Mental Status Examination" },
        { "type": "comment", "name": "rbh_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "rbh_rating_scales", "title": "Rating Scales" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment and Plan",
      "elements": [
        { "type": "comment", "name": "rbh_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
  NewMedicalVisit: {
  "title": "New Medical Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "nmv_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "nmv_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "nmv_medical_history", "title": "Medical History" },
        { "type": "comment", "name": "nmv_surgical_history", "title": "Surgical History" },
        { "type": "comment", "name": "nmv_medications_supplements", "title": "Medications and Supplements" },
        { "type": "comment", "name": "nmv_allergies", "title": "Allergies" },
        { "type": "comment", "name": "nmv_social_history", "title": "Social History" },
        { "type": "comment", "name": "nmv_family_history", "title": "Family History" },
        { "type": "comment", "name": "nmv_immunizations", "title": "Immunizations" },
        { "type": "comment", "name": "nmv_review_of_systems", "title": "Review of Systems" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "nmv_physical_exam", "title": "Physical Examination" },
        { "type": "comment", "name": "nmv_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "nmv_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" },
        { "type": "comment", "name": "nmv_rating_scales", "title": "Rating Scales" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment and Plan",
      "elements": [
        { "type": "comment", "name": "nmv_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
  ReturnAddictionMedVisit: {
  "title": "Return Addiction Med Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "ramv_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "ramv_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "ramv_medications_supplements", "title": "Medications and Supplements" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "ramv_mental_status_exam", "title": "Mental Status Examination" },
        { "type": "comment", "name": "ramv_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "ramv_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" },
        { "type": "comment", "name": "ramv_rating_scales", "title": "Rating Scales" }
      ]
    }
  ]
},
   NewBehavioralHealthVisit: {
  "title": "New Behavioral Health Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "nbhv_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "nbhv_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "nbhv_medical_history", "title": "Medical History" },
        { "type": "comment", "name": "nbhv_surgical_history", "title": "Surgical History" },
        { "type": "comment", "name": "nbhv_medications_supplements", "title": "Medications and Supplements" },
        { "type": "comment", "name": "nbhv_allergies", "title": "Allergies" },
        { "type": "comment", "name": "nbhv_family_history", "title": "Family History" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "nbhv_mental_status_exam", "title": "Mental Status Examination" },
        { "type": "comment", "name": "nbhv_rating_scales", "title": "Rating Scales" },
        { "type": "comment", "name": "nbhv_vital_signs", "title": "Vital Signs" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment & Plan",
      "elements": [
        { "type": "comment", "name": "nbhv_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
   NewPsychVisit: {
  "title": "New Psych Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "npv_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "npv_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "npv_medical_history", "title": "Medical History" },
        { "type": "comment", "name": "npv_surgical_history", "title": "Surgical History" },
        { "type": "comment", "name": "npv_medications_supplements", "title": "Medications and Supplements" },
        { "type": "comment", "name": "npv_allergies", "title": "Allergies" },
        { "type": "comment", "name": "npv_social_history", "title": "Social History" },
        { "type": "comment", "name": "npv_family_history", "title": "Family History" },
        { "type": "comment", "name": "npv_review_of_systems", "title": "Review of Systems" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "npv_mental_status_exam", "title": "Mental Status Examination" },
        { "type": "comment", "name": "npv_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "npv_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" },
        { "type": "comment", "name": "npv_rating_scales", "title": "Rating Scales" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment & Plan",
      "elements": [
        { "type": "comment", "name": "npv_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
     ReturnMedicalVisit: {
  "title": "Return Medical Visit",
  "elements": [
    {
      "type": "panel",
      "name": "subjective_panel",
      "title": "Subjective",
      "elements": [
        { "type": "comment", "name": "rmv_chief_complaint", "title": "Chief Complaint" },
        { "type": "comment", "name": "rmv_present_illness", "title": "History of Present Illness" },
        { "type": "comment", "name": "rmv_medications_supplements", "title": "Medications and Supplements" },
        { "type": "comment", "name": "rmv_review_of_systems", "title": "Review of Systems" }
      ]
    },
    {
      "type": "panel",
      "name": "objective_panel",
      "title": "Objective",
      "elements": [
        { "type": "comment", "name": "rmv_physical_exam", "title": "Physical Examination" },
        { "type": "comment", "name": "rmv_vital_signs", "title": "Vital Signs" },
        { "type": "comment", "name": "rmv_lab_imaging_test_results", "title": "Laboratory, Imaging, and Diagnostic Test Results" },
        { "type": "comment", "name": "rmv_rating_scales", "title": "Rating Scales" }
      ]
    },
    {
      "type": "panel",
      "name": "assessment_panel",
      "title": "Assessment & Plan",
      "elements": [
        { "type": "comment", "name": "rmv_assessment_plan", "title": "Problem Based Assessment Plan" }
      ]
    }
  ]
},
      psych_visit: {
        title: "Psych Visit",
        elements: [
          { type: "comment", name: "ps_chief_complaint", title: "Chief Complaint" },
          { type: "comment", name: "ps_present_illness", title: "History of Present Illness" },
          { type: "comment", name: "ps_medications_supplements", title: "Medications and Supplements" },
          { type: "comment", name: "ps_vital_signs", title: "Vital Signs" },
          { type: "comment", name: "ps_assessment_plan", title: "Problem Based Assessment and Plan" }
        ]
      },
      other: {
        title: "Other Visit",
        elements: [
          { type: "comment", name: "other_notes", title: "Other Notes" }
        ]
      }
    };





   let currentForm = "NewPatient";
    let survey;
   
     let cachedData = {};
    function loadSurvey(formKey) {
      console.log("Loading survey for form:", formKey);
  const form = formTemplates[formKey];
  if (!form) {
    console.error("Form template not found for key:", formKey);
    return;}

      // Hidden patient info fields (always added)
      const hiddenPatientFields = [
        { type: "text", name: "patient_first_name", visible: false },
        { type: "text", name: "patient_last_name", visible: false },
        { type: "text", name: "patient_dob", visible: false },
        { type: "text", name: "patient_id_number", visible: false }
      ];

      const elementsWithHiddenPatientInfo = [...form.elements, ...hiddenPatientFields];

      const surveyJson = {
        title: "Clinic Visit Forms",
        showQuestionNumbers: "off",
        showProgressBar: "top",
        pages: [{
          title: form.title,
          elements: elementsWithHiddenPatientInfo
        }]
      };

      survey = new Survey.Model(surveyJson);
 survey.onAfterRenderPanel.add((survey, options) => {
  const panel = options.panel;

  if (panel.name === "subjective_panel" || panel.name === "objective_panel") {
    const toggleBtn = document.createElement("button");
    toggleBtn.innerText = "Toggle Fields";
    toggleBtn.style.marginLeft = "12px";
    toggleBtn.style.padding = "4px 10px";
    toggleBtn.style.fontSize = "12px";
    toggleBtn.style.borderRadius = "4px";
    toggleBtn.style.cursor = "pointer";
    toggleBtn.style.backgroundColor = "#f0f0f0";
    toggleBtn.style.border = "1px solid #ccc";

    let hidden = false;

    toggleBtn.addEventListener("click", () => {
      hidden = !hidden;
      panel.elements.forEach(el => el.visible = !hidden);
    });

    // Fix: more reliable selector
    const titleEl = options.htmlElement.querySelector(".sv-panel__title");
    if (titleEl) {
      titleEl.appendChild(toggleBtn);
    } else {
      console.warn("Could not find title element for panel:", panel.name);
    }
  }
});


      $("#surveyContainer").Survey({ model: survey });
    }

    // Map from webhook keys (np_ keys) to all form fields across forms
const formFieldMappings = {
    NewPatient: {
    np_chief_complaint: "np_chief_complaint",
    np_present_illness: "np_present_illness",
    np_medical_history: "np_medical_history",
    np_surgical_history: "np_surgical_history",
    np_medications_supplements: "np_medications_supplements",
    np_allergies: "np_allergies",
    np_social_history: "np_social_history",
    np_family_history: "np_family_history",
    np_review_of_systems: "np_review_of_systems",
    np_mental_status_exam: "np_mental_status_exam",
    np_vital_signs: "np_vital_signs",
    np_lab_imaging_test_results: "np_lab_imaging_test_results",
    np_rating_scales: "np_rating_scales"
  },
  ReturningPatient: {
    np_chief_complaint: "rp_chief_complaint",
    np_present_illness: "rp_present_illness",
    np_medications_supplements: "rp_medications_supplements",
    np_mental_status_exam: "rp_mental_status_exam",
    np_vital_signs: "rp_vital_signs",
    np_lab_imaging_test_results: "rp_lab_imaging_test_results",
    np_rating_scales: "rp_rating_scales"
  },

   FocusedEmergencyDeptVisit: {
    np_chief_complaint: "fud_chief_complaint",
    np_present_illness: "fud_present_illness",
    np_medications_supplements: "fud_medications_supplements",
    np_allergies: "fud_allergies",
    np_vital_signs: "fud_vital_signs",
    np_physical_exam: "fud_physical_exam",
    np_lab_imaging_test_results: "fud_lab_imaging_test_results",
    np_medical_decision_making: "fud_medical_decision_making",
    np_assessment_plan: "fud_assessment_plan"
  },
   NewAddictionMedVisit: {
    np_chief_complaint: "nam_chief_complaint",
    np_present_illness: "nam_present_illness",
    np_medical_history: "nam_medical_history",
    np_surgical_history: "nam_surgical_history",
    np_medications_supplements: "nam_medications_supplements",
    np_allergies: "nam_allergies",
    np_social_history: "nam_social_history",
    np_family_history: "nam_family_history",
    np_review_of_systems: "nam_review_of_systems",
    np_mental_status_exam: "nam_mental_status_exam",
    np_vital_signs: "nam_vital_signs",
    np_lab_imaging_test_results: "nam_lab_imaging_test_results",
    np_rating_scales: "nam_rating_scales"
  },
  ReturnPsychVisit: {
    np_chief_complaint: "rpv_chief_complaint",
    np_present_illness: "rpv_present_illness",
    np_medications_supplements: "rpv_medications_supplements",
    np_mental_status_exam: "rpv_mental_status_exam",
    np_vital_signs: "rpv_vital_signs",
    np_lab_imaging_test_results: "rpv_lab_imaging_test_results",
    np_rating_scales: "rpv_rating_scales",
    np_assessment_plan: "rpv_assessment_plan"
  },
    PsychotherapySubjective: {
    np_psychotherapy_subjective: "pss_subjective",
    np_medications_supplements: "pss_medications_supplements",
    np_mental_status_exam: "pss_mental_status_exam",
    np_vital_signs: "pss_vital_signs",
    np_rating_scales: "pss_rating_scales",
    np_assessment_plan: "pss_assessment_plan"
  },
   FollowUpVisit: {
    np_chief_complaint: "fuv_chief_complaint",
    np_present_illness: "fuv_present_illness",
    np_medications_supplements: "fuv_medications_supplements",
    np_review_of_systems: "fuv_review_of_systems",
    np_physical_exam: "fuv_physical_exam",
    np_vital_signs: "fuv_vital_signs",
    np_lab_imaging_test_results: "fuv_lab_imaging_test_results",
    np_assessment_plan: "fuv_assessment_plan"
  },
   ReturnBehavioralHealthVisit: {
    np_chief_complaint: "rbh_chief_complaint",
    np_present_illness: "rbh_present_illness",
    np_medications_supplements: "rbh_medications_supplements",
    np_mental_status_exam: "rbh_mental_status_exam",
    np_vital_signs: "rbh_vital_signs",
    np_rating_scales: "rbh_rating_scales",
    np_assessment_plan: "rbh_assessment_plan"
  },
    NewMedicalVisit: {
    np_chief_complaint: "nmv_chief_complaint",
    np_present_illness: "nmv_present_illness",
    np_medical_history: "nmv_medical_history",
    np_surgical_history: "nmv_surgical_history",
    np_medications_supplements: "nmv_medications_supplements",
    np_allergies: "nmv_allergies",
    np_social_history: "nmv_social_history",
    np_family_history: "nmv_family_history",
    np_immunizations: "nmv_immunizations",
    np_review_of_systems: "nmv_review_of_systems",
    np_physical_exam: "nmv_physical_exam",
    np_vital_signs: "nmv_vital_signs",
    np_lab_imaging_test_results: "nmv_lab_imaging_test_results",
    np_rating_scales: "nmv_rating_scales",
    np_assessment_plan: "nmv_assessment_plan"
  },
   ReturnAddictionMedVisit: {
    np_chief_complaint: "ramv_chief_complaint",
    np_present_illness: "ramv_present_illness",
    np_medications_supplements: "ramv_medications_supplements",
    np_mental_status_exam: "ramv_mental_status_exam",
    np_vital_signs: "ramv_vital_signs",
    np_lab_imaging_test_results: "ramv_lab_imaging_test_results",
    np_rating_scales: "ramv_rating_scales"
  },
  NewBehavioralHealthVisit: {
    np_chief_complaint: "nbhv_chief_complaint",
    np_present_illness: "nbhv_present_illness",
    np_medical_history: "nbhv_medical_history",
    np_surgical_history: "nbhv_surgical_history",
    np_medications_supplements: "nbhv_medications_supplements",
    np_allergies: "nbhv_allergies",
    np_family_history: "nbhv_family_history",
    np_mental_status_exam: "nbhv_mental_status_exam",
    np_rating_scales: "nbhv_rating_scales",
    np_vital_signs: "nbhv_vital_signs",
    np_assessment_plan: "nbhv_assessment_plan"
  },
  NewPsychVisit: {
    np_chief_complaint: "npv_chief_complaint",
    np_present_illness: "npv_present_illness",
    np_medical_history: "npv_medical_history",
    np_surgical_history: "npv_surgical_history",
    np_medications_supplements: "npv_medications_supplements",
    np_allergies: "npv_allergies",
    np_social_history: "npv_social_history",
    np_family_history: "npv_family_history",
    np_review_of_systems: "npv_review_of_systems",
    np_mental_status_exam: "npv_mental_status_exam",
    np_vital_signs: "npv_vital_signs",
    np_lab_imaging_test_results: "npv_lab_imaging_test_results",
    np_rating_scales: "npv_rating_scales",
    np_assessment_plan: "npv_assessment_plan"
  },
   ReturnMedicalVisit: {
    np_chief_complaint: "rmv_chief_complaint",
    np_present_illness: "rmv_present_illness",
    np_medications_supplements: "rmv_medications_supplements",
    np_review_of_systems: "rmv_review_of_systems",
    np_physical_exam: "rmv_physical_exam",
    np_vital_signs: "rmv_vital_signs",
    np_lab_imaging_test_results: "rmv_lab_imaging_test_results",
    np_rating_scales: "rmv_rating_scales",
    np_assessment_plan: "rmv_assessment_plan"
  },
  // other formFieldMappings...

  follow_up_visit: {
    np_chief_complaint: "fuv_chief_complaint",
    np_present_illness: "fuv_present_illness",
    np_medications_supplements: "fuv_medications_supplements",
    np_vital_signs: "fuv_vital_signs",
    np_assessment_plan: "fuv_assessment_plan"
  },
  psych_visit: {
    np_chief_complaint: "ps_chief_complaint",
    np_present_illness: "ps_present_illness",
    np_medications_supplements: "ps_medications_supplements",
    np_vital_signs: "ps_vital_signs",
    np_assessment_plan: "ps_assessment_plan"
  }
};

function fillSurveyFromData(data) {
  if (!data || !survey) return;

  cachedData = data;

  survey.clear();

  const mapping = formFieldMappings[currentForm] || {};

  for (const npKey in data) {
    if (!(npKey in mapping)) continue;

    const formFieldName = mapping[npKey];
    const question = survey.getQuestionByName(formFieldName);

    if (question) {
      survey.setValue(formFieldName, data[npKey]);
    }
  }

  // Clear fields not set from data
  const allFieldsInForm = survey.getAllQuestions().map(q => q.name);
  allFieldsInForm.forEach(fieldName => {
    if (!survey.getValue(fieldName)) {
      survey.setValue(fieldName, "");
    }
  });

  survey.currentPageNo = 0;
  survey.render();
}






    // Toggle Patient Info modal
    document.getElementById("togglePatientInfo").addEventListener("click", () => {
      if (!survey) return;

      const data = survey.data || {};

      document.getElementById("modal_first_name").value = data.patient_first_name || "";
      document.getElementById("modal_last_name").value = data.patient_last_name || "";
      document.getElementById("modal_dob").value = data.patient_dob || "";
      document.getElementById("modal_id_number").value = data.patient_id_number || "";

      document.getElementById("patientInfoModal").style.display = "flex";
    });

    // Save modal data
    document.getElementById("patientInfoSaveBtn").addEventListener("click", () => {
      if (!survey) return;

      survey.setValue("patient_first_name", document.getElementById("modal_first_name").value);
      survey.setValue("patient_last_name", document.getElementById("modal_last_name").value);
      survey.setValue("patient_dob", document.getElementById("modal_dob").value);
      survey.setValue("patient_id_number", document.getElementById("modal_id_number").value);

      document.getElementById("patientInfoModal").style.display = "none";
    });

    // Cancel modal
    document.getElementById("patientInfoCancelBtn").addEventListener("click", () => {
      document.getElementById("patientInfoModal").style.display = "none";
    });

    // Form selector change handler
    document.getElementById("formSelector").addEventListener("change", function (e) {
      currentForm = e.target.value;
      $("#surveyContainer").empty();
      loadSurvey(currentForm);

      if (cachedData) {
        // Slight delay to ensure survey is loaded before filling data
        setTimeout(() => fillSurveyFromData(cachedData), 200);
      }
    });

    // Audio upload and webhook call
    document.getElementById("audioUpload").addEventListener("change", async function (e) {
      const file = e.target.files[0];
      const status = document.getElementById("loadingStatus");

      if (!file) {
        alert("Please upload a valid audio file.");
        return;
      }

      status.textContent = "Uploading and processing audio...";

      const formData = new FormData();
      formData.append("file", file);

      try {
        const response = await fetch("https://acai.app.n8n.cloud/webhook/mp3", {
          method: "POST",
          body: formData
        });

        if (!response.ok) throw new Error("Webhook call failed");

        const data = await response.json();
        console.log("Fetched response from n8n webhook:", data);
        const objData = Array.isArray(data) && data.length > 0 ? data[0] : data;

console.log("Fetched response from n8n webhook:", objData);
fillSurveyFromData(objData);
        const formattedOutputEl = document.getElementById("formattedJsonOutput");
if (formattedOutputEl && data.formatted_json_output) {
  formattedOutputEl.innerHTML = data.formatted_json_output;
}



        status.textContent = "Form filled successfully.";
        setTimeout(() => (status.textContent = ""), 3000);
      } catch (error) {
        console.error("Audio processing failed:", error);
        // status.textContent = "";
        // alert("There was an error processing the audio file.");
      }
    });
  


const pdfInput = document.getElementById("pdfUpload");
const sendBtn = document.getElementById("sendPdfBtn");
const statusMsg = document.getElementById("statusMessage");

pdfInput.addEventListener("change", () => {
  sendBtn.disabled = !pdfInput.files.length;
  statusMsg.textContent = "";
});
sendBtn.addEventListener("click", async () => {
  const rawJsonOutput = document.getElementById("formattedJsonOutput").textContent.trim();

  if (!rawJsonOutput) {
    alert("No raw JSON data available to send.");
    return;
  }

  try {
    statusMsg.style.color = "black";
    statusMsg.textContent = "Generating PDF from JSON data...";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const splitText = doc.splitTextToSize(rawJsonOutput, 180);

    doc.text("Raw JSON Output from Audio", 10, 10);
    doc.text(splitText, 10, 20);

    const pdfBlob = doc.output("blob");

    const formData = new FormData();
    formData.append("file", pdfBlob, "raw_json_output.pdf");

    const url = "https://mmj.advancedcare.com/api/ac/file/upload?patient_id=1";

    statusMsg.textContent = "Uploading PDF generated from JSON...";

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Authorization": "8e0f67df-5ce8-4de9-9707-1035d79a3296"
      },
      body: formData
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Upload failed: ${response.status} ${errorText}`);
    }

    const result = await response.json();

    // Show success message
    statusMsg.style.color = "green";
    statusMsg.textContent = "✅ PDF generated from JSON uploaded successfully!";

    // Optional popup alert
    alert("Data has been sent successfully to EMR!");

    console.log("Upload response:", result);

    // Clear message after 5 seconds
    setTimeout(() => {
      statusMsg.textContent = "";
    }, 5000);

  } catch (err) {
    console.error(err);
    statusMsg.style.color = "red";
    statusMsg.textContent = `Error: ${err.message}`;
  }
});


 document.addEventListener("DOMContentLoaded", () => {
      const pdfInput = document.getElementById("pdfUpload");
      const sendBtn = document.getElementById("sendPdfBtn");
      const statusMsg = document.getElementById("statusMessage");

      // Enable send button only when PDF file is selected
      pdfInput.addEventListener("change", () => {
        sendBtn.disabled = !pdfInput.files.length;
        statusMsg.textContent = "";
      });

      // Send PDF generated from raw JSON output on button click
      sendBtn.addEventListener("click", async () => {
        const rawJsonOutput = document.getElementById("rawJsonOutput").textContent.trim();

        if (!rawJsonOutput) {
          alert("No raw JSON data available to send.");
          return;
        }

        try {
          statusMsg.textContent = "Generating PDF from JSON data...";

          const { jsPDF } = window.jspdf;
          const doc = new jsPDF();

          // Split long text to fit page width
          const splitText = doc.splitTextToSize(rawJsonOutput, 180);

          doc.text("Raw JSON Output from Audio", 10, 10);
          doc.text(splitText, 10, 20);

          // Output PDF as blob
          const pdfBlob = doc.output("blob");

          // Prepare FormData with generated PDF blob
          const formData = new FormData();
          formData.append("file", pdfBlob, "raw_json_output.pdf");

          const url = "https://mmj.advancedcare.com/api/ac/file/upload?patient_id=1";

          statusMsg.textContent = "Uploading PDF generated from JSON...";

          const response = await fetch(url, {
            method: "POST",
            headers: {
              "Authorization": "8e0f67df-5ce8-4de9-9707-1035d79a3296"
              // Do NOT set Content-Type manually when using FormData — browser handles it.
            },
            body: formData
          });

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Upload failed: ${response.status} ${errorText}`);
          }

          const result = await response.json();
          statusMsg.textContent = "PDF generated from JSON uploaded successfully!";
          console.log("Upload response:", result);
        } catch (err) {
          console.error(err);
          statusMsg.textContent = `Error: ${err.message}`;
        }
      });

      // Call your existing survey load function here if needed
      // loadSurvey(currentForm);
    });


    const downloadBtn = document.getElementById("downloadPdfBtn");

let lastPdfBlob = null;  // to store the last generated PDF blob

sendBtn.addEventListener("click", async () => {
 const formattedOutputEl = document.getElementById("formattedJsonOutput");
const plainText = formattedOutputEl?.innerHTML
  .replace(/<br\s*\/?>/gi, "\n")
  .replace(/&nbsp;/g, " ")
  .replace(/&quot;/g, '"')
  .replace(/&lt;/g, "<")
  .replace(/&gt;/g, ">")
  .replace(/&amp;/g, "&")
  .replace(/<[^>]+>/g, "")
  .trim();

if (!plainText) {
  alert("No formatted data available to send.");
  return;
}


  try {
    statusMsg.textContent = "Generating PDF from JSON data...";

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const splitText = doc.splitTextToSize(plainText, 180);
doc.text("Formatted JSON Output", 10, 10);
doc.text(splitText, 10, 20);


    // Output PDF as blob
    lastPdfBlob = doc.output("blob");

    // Enable download button now that PDF is generated
    downloadBtn.disabled = false;

    // Prepare FormData and send
    const formData = new FormData();
    formData.append("file", lastPdfBlob, "raw_json_output.pdf");

    const url = "https://mmj.advancedcare.com/api/ac/file/upload?patient_id=1";

    statusMsg.textContent = "Uploading PDF generated from JSON...";

    const response = await fetch(url, {
      method: "POST",
      headers: {
        "Authorization": "8e0f67df-5ce8-4de9-9707-1035d79a3296"
      },
      body: formData
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Upload failed: ${response.status} ${errorText}`);
    }

    const result = await response.json();
    statusMsg.textContent = "PDF generated from JSON uploaded successfully!";
    console.log("Upload response:", result);
  } catch (err) {
    console.error(err);
    statusMsg.textContent = `Error: ${err.message}`;
  }
});

// Download PDF button handler
downloadBtn.addEventListener("click", () => {
  if (!lastPdfBlob) {
    alert("No PDF available for download.");
    return;
  }

  const url = URL.createObjectURL(lastPdfBlob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "raw_json_output.pdf";
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
  

// const API_KEY = "OTEaQ3hy00lqC7SGm00brFlB9hJ84HhL";

// async function fetchJobs() {
//   const response = await fetch("https://asr.api.speechmatics.com/v2/jobs/", {
//     headers: {
//       Authorization: `Bearer ${API_KEY}`,
//     },
//   });
//   if (!response.ok) throw new Error("Failed to fetch jobs");
//   return response.json();
// }

// async function fetchTranscript(jobId) {
//   const response = await fetch(`https://asr.api.speechmatics.com/v2/jobs/${jobId}/transcript?format=txt`, {
//     headers: {
//       Authorization: `Bearer ${API_KEY}`,
//     },
//   });
//   if (!response.ok) throw new Error(`Failed to fetch transcript for job ${jobId}`);
//   return response.text();
// }

// document.getElementById("formSelector").addEventListener("change", async function () {
//   if (this.value === "SavedTranscripts") {
//     const container = document.getElementById("transcriptContainer");
//     container.textContent = "Loading transcripts...";

//     try {
//       const jobsData = await fetchJobs();
//       const jobs = jobsData.jobs || [];

//       if (jobs.length === 0) {
//         container.textContent = "No saved transcripts found.";
//         return;
//       }

//       let transcriptsHtml = "";
//       for (const job of jobs) {
//         const transcriptText = await fetchTranscript(job.id);
//         transcriptsHtml += `
//           <div class="transcript-item">
//             <h3>Job ID: ${job.id}</h3>
//             <pre>${transcriptText}</pre>
//           </div>
//         `;
//       }

//       container.innerHTML = transcriptsHtml;
//     } catch (error) {
//       container.textContent = "Error loading transcripts.";
//       console.error(error);
//     }
//   }
// });


document.getElementById("formSelector").addEventListener("change", function () {
  const val = this.value;
  if (val === "SavedTranscripts") {
    window.open("new.html", "_blank"); // Open in new tab
    // Optionally reset selection to previous or default value
    this.value = "NewPatient"; 
  } else {
    // Load your normal survey form here
    currentForm = val;
    $("#surveyContainer").empty();
    loadSurvey(currentForm);
  }
});




    
    // Initial load
    loadSurvey(currentForm);
  </script>

</body>
</html>
